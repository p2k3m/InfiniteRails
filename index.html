<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infinite Dimension · Portals Reimagined</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Exo+2:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="background-sheen"></div>
    <div class="manu-logo" aria-hidden="false">
      <img src="assets/manu-logo.svg" alt="Created by Manu" class="manu-logo__image" />
    </div>
    <header class="top-bar">
      <div class="logo-area">
        <img src="assets/infinite-dimension-logo.svg" alt="Infinite Dimension logo" class="brand-logo" />
        <div class="brand-copy">
          <h1>Infinite Dimension</h1>
          <span class="subtitle">Portals Reimagined</span>
        </div>
      </div>
      <div class="top-bar__center">
        <button
          type="button"
          id="openLeaderboard"
          class="leaderboard-toggle"
          aria-haspopup="dialog"
          aria-controls="leaderboardModal"
          aria-expanded="false"
        >
          <span class="leaderboard-toggle__icon" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
          <span class="leaderboard-toggle__label">Leaderboard</span>
        </button>
      </div>
      <div class="top-actions">
        <button type="button" id="openGuide" class="ghost">Game Guide</button>
        <button
          type="button"
          id="toggleSidebar"
          class="ghost mobile-sidebar-toggle"
          aria-expanded="false"
          aria-controls="sidePanel"
        >
          Player Panels
        </button>
        <div class="status-area">
          <div class="status-item hearts" id="hearts"></div>
          <div class="status-item bubbles" id="bubbles"></div>
          <div class="status-item time" id="timeOfDay"></div>
          <button
            type="button"
            class="craft-launcher"
            id="openCrafting"
            aria-label="Open crafting interface"
            aria-haspopup="dialog"
            aria-controls="craftingModal"
          >
            <span aria-hidden="true" class="craft-launcher__icon"></span>
            <span class="sr-only">Open crafting interface</span>
          </button>
        </div>
        <div class="user-identity" aria-live="polite">
          <span class="user-name" id="headerUserName">Guest Explorer</span>
          <span class="user-location" id="headerUserLocation">Location unavailable</span>
        </div>
      </div>
    </header>
    <main class="main-layout">
      <section class="primary-panel">
        <canvas id="gameCanvas" width="960" height="600" aria-label="Game world"></canvas>
        <div class="overlay-panel" id="dimensionInfo" aria-live="polite"></div>
        <div
          class="portal-progress"
          id="portalProgress"
          role="progressbar"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="0"
        >
          <span class="label"></span>
          <span class="bar"></span>
        </div>
        <div class="score-overlay" id="scorePanel" role="status" aria-live="polite">
          <span class="score-overlay__label">Score</span>
          <span class="score-overlay__value" id="scoreTotal">0</span>
          <ul class="score-overlay__breakdown">
            <li>
              <span class="score-overlay__metric-label">Recipes</span>
              <span class="score-overlay__metric-value" id="scoreRecipes">0 (+0 pts)</span>
            </li>
            <li>
              <span class="score-overlay__metric-label">Dimensions</span>
              <span class="score-overlay__metric-value" id="scoreDimensions">0 (+0 pts)</span>
            </li>
          </ul>
        </div>
        <div class="victory-banner" id="victoryBanner" role="status" aria-live="assertive"></div>
        <div class="player-hint" id="playerHint" role="status" aria-live="assertive" tabindex="0"></div>
        <div class="drowning-vignette" id="drowningVignette" aria-hidden="true"></div>
        <div class="dimension-transition" id="dimensionTransition" aria-hidden="true"></div>
        <div
          class="defeat-overlay"
          id="defeatOverlay"
          aria-hidden="true"
          tabindex="-1"
        >
          <div class="defeat-overlay__content" role="dialog" aria-modal="true" aria-labelledby="defeatTitle">
            <h3 id="defeatTitle">Respawn Imminent</h3>
            <p class="defeat-overlay__message" id="defeatMessage"></p>
            <div class="defeat-overlay__inventory" id="defeatInventory" aria-live="polite"></div>
            <p class="defeat-overlay__countdown" id="defeatCountdown"></p>
          </div>
        </div>
      </section>
      <aside class="side-panel" id="sidePanel" tabindex="-1">
        <section class="player-panel" aria-label="Player profile">
          <header class="player-panel__header">
            <h2>Player Hub</h2>
            <button type="button" class="ghost small side-panel-close" data-close-sidebar aria-label="Close player panels">
              Close
            </button>
            <button type="button" id="googleSignOut" class="ghost small" data-google-sign-out hidden>
              Sign out
            </button>
          </header>
          <div class="player-panel__content">
            <div class="identity-pill" id="userNameDisplay">Guest Explorer</div>
            <div class="identity-meta">
              <span id="userLocationDisplay">Location unavailable</span>
              <span id="userDeviceDisplay">Device details pending</span>
            </div>
            <div class="gsi-container" data-google-button-container hidden></div>
            <button type="button" class="primary" data-google-fallback-signin>Sign in with Google</button>
            <p class="player-panel__hint">
              Sign in to capture your location badge, sync your device fingerprint, and compete on the Infinite Dimension scorecard.
            </p>
          </div>
        </section>
        <section class="inventory-panel">
          <h2>Inventory</h2>
          <div class="hotbar" id="hotbar"></div>
          <button class="toggle-extended" id="toggleExtended">Open Satchel</button>
          <div class="extended" id="extendedInventory"></div>
        </section>
        <section class="codex-panel" aria-label="Dimension codex">
          <header>
            <h2>Dimension Codex</h2>
          </header>
          <ul id="dimensionCodex"></ul>
        </section>
        <section class="log-panel" aria-live="polite">
          <header>
            <h2>Event Log</h2>
          </header>
          <ul id="eventLog"></ul>
        </section>
      </aside>
    </main>
    <div class="side-panel__scrim" id="sidePanelScrim" hidden></div>
    <footer class="footer">
      <div class="controls">
        <div>
          <h3>Desktop Controls</h3>
          <p>
            WASD/Arrows move · Space interact · Q place block · E inventory · R build portal · F use · Shift sprint · Click or
            tap to gather
          </p>
        </div>
        <div>
          <h3>Mobile Controls</h3>
          <p>Swipe to move · Tap hold to interact · Tap buttons for craft/build</p>
        </div>
      </div>
    </footer>

    <div class="modal" id="introModal" role="dialog" aria-modal="true" aria-labelledby="introTitle">
      <div class="modal-content">
        <h2 id="introTitle">Welcome to Infinite Dimension</h2>
        <p>
          Survive, craft, and weave portals across dimensions. Gather resources from each world, solve rail puzzles,
          and bring home the Eternal Ingot.
        </p>
        <section class="signin-callout" id="landingSignInPanel" aria-label="Link your explorer profile">
          <h3>Sync your journey before you depart</h3>
          <p class="signin-callout__summary">
            Sign in with Google to unlock the shared scoreboard, capture your location badge, and mirror your progress across
            every device.
          </p>
          <div class="signin-callout__actions">
            <div class="gsi-container" data-google-button-container hidden></div>
            <button type="button" class="primary" data-google-fallback-signin>Sign in with Google</button>
            <p class="signin-callout__note">Prefer to explore as a guest? You can connect later from the Player Hub.</p>
          </div>
        </section>
        <ul class="modal-highlights">
          <li>Build 4×3 portals with unique materials to unlock new rules.</li>
          <li>Craft using ordered sequences and uncover hidden recipes.</li>
          <li>Survive nightly assaults while protecting villagers and rails.</li>
        </ul>
        <button id="startButton" class="primary">Enter the Rails</button>
      </div>
    </div>

    <div
      class="modal crafting-modal"
      id="craftingModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="craftingTitle"
      hidden
    >
      <div class="modal-content crafting-modal__content">
        <button type="button" class="crafting-modal__close" id="closeCrafting" aria-label="Close crafting interface"></button>
        <header class="crafting-modal__header">
          <div>
            <p class="crafting-modal__eyebrow">Assembly Sequence</p>
            <h2 id="craftingTitle">Crafting Matrix</h2>
            <p class="crafting-modal__intro">
              Arrange resources across up to seven slots in the exact order. Known recipes can auto-fill from the library
              or the search suggestions below.
            </p>
          </div>
        </header>
        <div class="crafting-modal__grid">
          <section class="crafting-modal__sequence" aria-label="Crafting sequence">
            <div class="crafting-sequence" id="craftSequence" data-slot-count="7"></div>
            <div class="crafting-actions">
              <button type="button" class="primary" id="craftButton" disabled>Craft Item</button>
              <button type="button" class="ghost" id="clearCraft">Clear Sequence</button>
            </div>
            <p class="crafting-hint">
              Tip: Click ingredients from your satchel to queue them. Slots collapse to the left as you remove steps.
            </p>
          </section>
          <section class="crafting-modal__recipes" aria-label="Recipe library">
            <label class="crafting-search" for="recipeSearch">
              Search library
              <span class="sr-only"> for recipes or ingredients</span>
            </label>
            <input type="search" id="recipeSearch" placeholder="Search recipes or ingredients" autocomplete="off" />
            <ul class="crafting-suggestions" id="craftSuggestions" role="listbox" aria-live="polite"></ul>
            <div class="recipe-list" id="recipeList" role="listbox" aria-live="polite"></div>
          </section>
        </div>
        <div class="crafting-confetti" id="craftConfetti" aria-hidden="true"></div>
      </div>
    </div>

    <div
      class="modal guide-modal"
      id="guideModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="guideTitle"
      hidden
    >
      <article class="guide-content" data-guide-scroll>
        <header class="guide-header">
          <div>
            <p class="guide-eyebrow">Game Design Document &amp; User Manual</p>
            <h2 id="guideTitle">Infinite Dimension: Portals Reimagined</h2>
          </div>
          <button type="button" class="ghost" data-close-guide>Close</button>
        </header>
        <section class="guide-section">
          <h3>Game Overview</h3>
          <p>
            Infinite Dimension is a browser-based voxel survival puzzle. Gather resources, craft ordered recipes, and build
            precise 4×3 portals to leap between realms. Each portal material rewrites the physics and threats of the
            destination dimension.
          </p>
          <ul>
            <li>Portals are the only way to explore fresh territories.</li>
            <li>Every material introduces a bespoke challenge and reward loop.</li>
            <li>Crafting is performed by sequencing items rather than arranging them in a grid.</li>
          </ul>
        </section>
        <section class="guide-section">
          <h3>Look &amp; Feel</h3>
          <p>Each dimension features a distinct ambience, palette, and soundtrack cues:</p>
          <ul>
            <li><strong>Rock:</strong> rugged canyons with dense gravity and ore-rich chasms.</li>
            <li><strong>Stone:</strong> glowing monochrome rails that phase in rhythmic patterns.</li>
            <li><strong>Tar:</strong> a viscous, low-visibility swamp that slows movement.</li>
            <li><strong>Marble:</strong> mirror-bright courtyards where actions echo after five seconds.</li>
            <li><strong>Netherite:</strong> molten rails collapse behind every step — the final gauntlet.</li>
          </ul>
        </section>
        <section class="guide-section">
          <h3>How to Play</h3>
          <ol>
            <li>Spawn on a quiet grass island. Search trees and stones for early materials.</li>
            <li>Use the craft circle next to your hearts to arrange items in the correct sequence.</li>
            <li>Build a 4×3 portal frame from a single material, leave the centre empty, and ignite it.</li>
            <li>Explore the new realm, solve its rail puzzle, and gather the unique loot inside.</li>
            <li>Survive the nightly zombie raids, protect villagers, and stabilise the rails.</li>
            <li>Repeat with higher-tier materials until you conquer the collapsing Netherite dimension.</li>
          </ol>
        </section>
        <section class="guide-section two-column">
          <div>
            <h4>Controls (Desktop)</h4>
            <ul>
              <li><kbd>WASD</kbd> / <kbd>Arrows</kbd> — move &amp; switch rails</li>
              <li><kbd>Space</kbd> — jump gaps</li>
              <li><kbd>Mouse</kbd> — look, mine, place</li>
              <li><kbd>E</kbd> — inventory</li>
              <li><kbd>F</kbd> — interact</li>
              <li><kbd>R</kbd> — build portals</li>
            </ul>
          </div>
          <div>
            <h4>Controls (Mobile)</h4>
            <ul>
              <li>Swipe to swap rails</li>
              <li>Tap &amp; hold to mine or place blocks</li>
              <li>Click or tap tiles to gather resources</li>
              <li>Use the hotbar for quick slots and the craft circle for recipes</li>
            </ul>
          </div>
        </section>
        <section class="guide-section">
          <h3>Dimensions &amp; Objectives</h3>
          <dl class="dimension-list">
            <div>
              <dt>Rock Portal</dt>
              <dd>Stronger gravity and sliding slopes. Rewards heavy ores and plating.</dd>
            </div>
            <div>
              <dt>Stone Portal</dt>
              <dd>Rails appear and vanish to a rhythm. Collect pattern crystals for sync tech.</dd>
            </div>
            <div>
              <dt>Tar Portal</dt>
              <dd>Movement is heavy and tar slugs pursue you. Gather sticky sacs for traps.</dd>
            </div>
            <div>
              <dt>Marble Portal</dt>
              <dd>Your actions echo after five seconds. Use the reverbs to solve mirrored puzzles.</dd>
            </div>
            <div>
              <dt>Netherite Portal</dt>
              <dd>Rails crumble behind you. Sprint, align collapsing tracks, and seize the Eternal Ingot.</dd>
            </div>
          </dl>
        </section>
        <section class="guide-section">
          <h3>Survival Cycle</h3>
          <p>
            Daytime is safe for crafting and exploration. When night falls, zombies swarm the rails and villagers risk
            conversion. Keep torches lit, stand your ground, and repair damage before dawn. Underwater exploration is
            limited by your bubbles: once they deplete, hearts drain rapidly.
          </p>
        </section>
        <section class="guide-section">
          <h3>Winning a Run</h3>
          <p>
            Reach the Netherite dimension, stabilise collapsing rails long enough to grab the Eternal Ingot, and return
            to the Grassland Threshold. Delivering the ingot home completes the run and logs your time on the leaderboards.
          </p>
        </section>
      </article>
    </div>

    <div
      class="modal leaderboard-modal"
      id="leaderboardModal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="leaderboardTitle"
      hidden
    >
      <div class="modal-content leaderboard-modal__content">
        <header class="leaderboard-modal__header">
          <div>
            <p class="leaderboard-modal__eyebrow">Global Rankings</p>
            <h2 id="leaderboardTitle">Multiverse Scoreboard</h2>
          </div>
          <button type="button" class="ghost small" id="closeLeaderboard" aria-label="Close leaderboard">Close</button>
        </header>
        <p class="leaderboard-status" id="scoreboardStatus" aria-live="polite"></p>
        <div class="leaderboard-controls">
          <button type="button" id="refreshScores" class="ghost small leaderboard-refresh" data-loading="false">
            <span class="leaderboard-refresh__spinner" aria-hidden="true"></span>
            <span class="leaderboard-refresh__label">Refresh</span>
          </button>
        </div>
        <div class="leaderboard-table__container" id="leaderboardTable" data-empty="true">
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th scope="col" class="leaderboard-col-rank">#</th>
                <th scope="col" class="leaderboard-sortable" data-sort-key="name" tabindex="0">Explorer</th>
                <th
                  scope="col"
                  class="leaderboard-sortable"
                  data-sort-key="score"
                  data-sort-direction="desc"
                  tabindex="0"
                >
                  Score
                </th>
                <th scope="col" class="leaderboard-sortable" data-sort-key="runTimeSeconds" tabindex="0">Run Time</th>
                <th scope="col" class="leaderboard-sortable" data-sort-key="dimensionCount" tabindex="0">Realms</th>
                <th scope="col" class="leaderboard-sortable" data-sort-key="inventoryCount" tabindex="0">Inventory</th>
                <th scope="col" class="leaderboard-sortable" data-sort-key="locationLabel" tabindex="0">Location</th>
                <th scope="col" class="leaderboard-sortable" data-sort-key="updatedAt" tabindex="0">Updated</th>
              </tr>
            </thead>
            <tbody id="scoreboardList"></tbody>
          </table>
          <p class="leaderboard-empty" id="leaderboardEmptyMessage">Sign in to publish your victories and see the live rankings.</p>
        </div>
      </div>
    </div>

    <div class="mobile-controls" id="mobileControls">
      <button data-action="left">◀</button>
      <button data-action="up">▲</button>
      <button data-action="down">▼</button>
      <button data-action="right">▶</button>
      <button data-action="action" class="accent">✦</button>
      <button data-action="portal" class="accent">⧉</button>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="vendor/three.min.js" defer></script>
    <script src="scoreboard-utils.js" defer></script>
    <script src="script.js" defer></script>
  </body>
</html>
