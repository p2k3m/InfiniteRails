AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >-
  Serverless backend for Infinite Dimension providing Google-authenticated user sync and a DynamoDB-backed scoreboard.

Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 10
    MemorySize: 256
    Environment:
      Variables:
        USERS_TABLE: !Ref UsersTable
        SCORES_TABLE: !Ref ScoresTable
        SCORES_INDEX_NAME: ScoreIndex

Resources:
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'OPTIONS,GET,POST'"
        AllowHeaders: "'Content-Type,Authorization,X-Requested-With'"
        AllowOrigin: "'*'"

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: googleId
          AttributeType: S
      KeySchema:
        - AttributeName: googleId
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true

  ScoresTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: googleId
          AttributeType: S
        - AttributeName: scoreBucket
          AttributeType: S
        - AttributeName: scoreSort
          AttributeType: N
      KeySchema:
        - AttributeName: googleId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: ScoreIndex
          KeySchema:
            - AttributeName: scoreBucket
              KeyType: HASH
            - AttributeName: scoreSort
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      SSESpecification:
        SSEEnabled: true

  UsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: handlers/users.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
      Events:
        PostUser:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users
            Method: post
        OptionsUser:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users
            Method: options

  ScoresFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: handlers/scores.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ScoresTable
      Events:
        GetScores:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /scores
            Method: get
        PostScore:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /scores
            Method: post
        OptionsScores:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /scores
            Method: options

Outputs:
  ApiEndpoint:
    Description: Invoke URL for the Infinite Dimension API Gateway stage.
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod'
  UsersTableName:
    Description: DynamoDB table storing Google-linked explorer profiles.
    Value: !Ref UsersTable
  ScoresTableName:
    Description: DynamoDB table storing multiverse scoreboard entries.
    Value: !Ref ScoresTable
